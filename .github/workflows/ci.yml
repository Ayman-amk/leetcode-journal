name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  python-tests:
    name: Python Tests & Linting
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Format check (Black)
        run: |
          black --check problems/ utils/ src/
      
      - name: Lint (Flake8)
        run: |
          flake8 problems/ utils/ src/ --max-line-length=88 --extend-ignore=E203,W503
      
      - name: Clean Python cache (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          find problems -type d -name __pycache__ -exec rm -r {} + 2>/dev/null || true
          find problems -name "*.pyc" -delete 2>/dev/null || true
      
      - name: Clean Python cache (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Get-ChildItem -Path problems -Recurse -Directory -Filter __pycache__ | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path problems -Recurse -Filter *.pyc | Remove-Item -Force -ErrorAction SilentlyContinue
      
      - name: Run Python tests (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          python -m pytest problems/ -v --tb=short --import-mode=importlib -k "test" || \
          for test_file in problems/*/python/test_solution.py; do
            if [ -f "$test_file" ]; then
              cd "$(dirname "$test_file")" && python -m pytest test_solution.py -v --tb=short && cd - > /dev/null
            fi
          done
      
      - name: Run Python tests (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          python -m pytest problems/ -v --tb=short --import-mode=importlib -k "test"
          if ($LASTEXITCODE -ne 0) {
            Get-ChildItem -Path problems -Recurse -Filter test_solution.py | ForEach-Object {
              $testDir = $_.DirectoryName
              Push-Location $testDir
              python -m pytest test_solution.py -v --tb=short
              Pop-Location
            }
          }
      
      - name: Generate coverage report
        run: |
          python -m pytest problems/ --cov=problems --cov-report=term-missing --cov-report=html --import-mode=importlib -k "test" || true
      
      - name: Upload coverage to artifacts
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          if-no-files-found: ignore

  cpp-tests:
    name: C++ Tests & Formatting
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up C++ compiler (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ clang-format clang-tidy
      
      - name: Set up C++ compiler (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install llvm
          echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH
      
      - name: Set up C++ compiler (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          # Windows runners typically have MinGW available
          # If not, we'll use MSVC or fall back to available compiler
          Write-Host "Checking for available C++ compiler..."
          if (Get-Command g++ -ErrorAction SilentlyContinue) {
            Write-Host "g++ found"
          } elseif (Get-Command cl -ErrorAction SilentlyContinue) {
            Write-Host "MSVC found"
          } else {
            Write-Host "No C++ compiler found, tests may fail"
          }
      
      - name: Format check (clang-format)
        shell: bash
        run: |
          if command -v clang-format &> /dev/null; then
            find problems -name "*.cpp" -o -name "*.h" | while read file; do
              clang-format --style=Google --dry-run --Werror "$file" || exit 1
            done
          else
            echo "clang-format not available, skipping format check"
          fi
        continue-on-error: true
      
      - name: Build and run C++ tests (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          find problems -name "test_solution.cpp" -type f | while read test_file; do
            problem_dir=$(dirname "$test_file")
            echo "Testing: $problem_dir"
            g++ -std=c++17 -O2 -Wall -Wextra -Werror "$test_file" -o "$problem_dir/test" || exit 1
            "$problem_dir/test" || exit 1
            rm -f "$problem_dir/test"
          done
      
      - name: Build and run C++ tests (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $testFiles = Get-ChildItem -Path problems -Recurse -Filter test_solution.cpp
          if ($testFiles.Count -eq 0) {
            Write-Host "No C++ test files found"
            exit 0
          }
          foreach ($testFile in $testFiles) {
            $testFilePath = $testFile.FullName
            $problemDir = $testFile.DirectoryName
            Write-Host "Testing: $problemDir"
            $exePath = Join-Path $problemDir "test.exe"
            # Try g++ first, then cl (MSVC)
            if (Get-Command g++ -ErrorAction SilentlyContinue) {
              g++ -std=c++17 -O2 -Wall -Wextra "$testFilePath" -o "$exePath"
              if ($LASTEXITCODE -ne 0) { exit 1 }
              & "$exePath"
              if ($LASTEXITCODE -ne 0) { exit 1 }
            } else {
              Write-Host "g++ not found, skipping C++ tests on Windows"
              exit 0
            }
            Remove-Item -Force "$exePath" -ErrorAction SilentlyContinue
          }

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [python-tests, cpp-tests]
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Count problems
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Total problems: $(find problems -mindepth 1 -maxdepth 1 -type d | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Python Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.python-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### C++ Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.cpp-tests.result }}" >> $GITHUB_STEP_SUMMARY

